---
title: "Introduction to Raster Data"
teaching: 15
exercises: 10
questions:
 - "What format should I use to represent my data?"
 - "What are the main data types used for representing geospatial data?"
 - "What are the main attributes of raster data?"
objectives:
- "Describe the difference between raster and vector data."
- "Describe the strengths and weaknesses of storing data in raster format."
- "Distinguish between continuous and categorical raster data and identify types of datasets that would be stored in each."
- "Name some common schemes for describing coordinate reference systems."
- "Interpret a PROJ4 coordinate reference system description."
keypoints:
 - TBD
source: Rmd
---

```{r, include=FALSE}
source("../bin/chunk-options.R")
source("../setup.R")
knitr_fig_path("01-")
```

This tutorial provides an overview of key spatial data concepts,
including structures and common storage and transfer formats. 
Each of these topics is covered in more detail in later lessons. 
This lesson provides just enough background information
to help you get started and to make sense of the later lessons in
this workshop.

# Data Structures: Raster and Vector

Brief intro to raster vs. vector. Link to next episode for 
intro to vector data. Link to appropriate sections of 
raster vector lesson for more detailed work. Include outline of
what will be covered in raster vector lesson?

## About Raster Data
Raster or "gridded" data are stored as a grid of values which are rendered on a
map as pixels. Each pixel value represents an area on the Earth's surface.

![Raster Councept]("../images/dc-spatial-raster/raster_concept.png")
Source: National Ecological Observatory Network (NEON)

The cell values can represent a continuous surface (e.g. elevation)
or a categorical classification (e.g. land use). If this sounds
familiar, it is because this data structure is very common: its how
we represent any digital image. A geospatial raster is only different
from a digital photo in that it is accompanied by spatial information
that connects the data to a particular location. This includes the
raster's extent and cell size, the number of rows and columns, and
its coordinate reference system (CRS, more on this later).

## Types of Data Stored in Raster Format
Raster data can be continuous or categorical. Continuous rasters can have a
range of quantitative values. Some examples of continuous rasters include:

1. Precipitation maps.
2. Maps of tree height derived from LiDAR data.
3. Elevation values for a region.

A map of elevation for Harvard Forest derived from the
<a href="http://www.neonscience.org/data-collection/airborne-remote-sensing" target="_blank">
NEON AOP LiDAR sensor</a>
is below. Elevation is represented as continuous numeric variable in this map. The legend
shows the continuous range of values in the data from around 300 to 420 meters.

```{r load-libraries-1, results='hide', echo=FALSE, message=FALSE}

library(raster)
library(rgdal)

```

```{r elevation-map, echo=FALSE}
# render DSM for tutorial content background
DSM_HARV <- raster("data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif")

library(ggplot2)

# convert to a df for plotting in two steps,
# First, to a SpatialPointsDataFrame
DSM_HARV_pts <- rasterToPoints(DSM_HARV, spatial = TRUE)
# Then to a 'conventional' dataframe
DSM_HARV_df  <- data.frame(DSM_HARV_pts)
rm(DSM_HARV_pts)

ggplot() +
geom_raster(data = DSM_HARV_df , aes(x = x, y = y, fill = HARV_dsmCrop)) +
ggtitle("Continuous Elevation Map - NEON Harvard Forest Field Site") +
coord_equal()

```

Some rasters contain categorical data where each pixel represents a discrete
class such as a landcover type (e.g., "forest" or "grassland") rather than a
continuous value such as elevation or temperature. Some examples of classified
maps include:

1. Landcover / land-use maps.
2. Tree height maps classified as short, medium, tall trees.
3. Elevation maps classified as low, medium and high elevation.

#### Categorical Landcover Map for the United States
<figure>
<a href="http://neondataskills.org/images/spatialData/NLCD06_conus_lg.gif ">
<img src="http://neondataskills.org/images/spatialData/NLCD06_conus_lg.gif">
</a>
<figcaption> Map of the United States showing landcover as categorical data.
Each color is a different landcover category.  Source:
<a href="http://www.mrlc.gov/nlcd06_data.php" target="_blank">
Multi-Resolution Land Characteristics Consortium, USGS</a>
</figcaption>
</figure>

#### Categorical Elevation Map of the NEON Harvard Forest Site
The legend of this map shows the colors representing each discrete class.

```{r classified-elevation-map, echo=FALSE, warning=FALSE, message=FALSE}

# Load raster into R
DSM_HARV <- raster("data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif")

# convert to a df for plotting in two steps,
# First, to a SpatialPointsDataFrame
DSM_HARV_pts <- rasterToPoints(DSM_HARV, spatial = TRUE)
# Then to a 'conventional' dataframe
DSM_HARV_df  <- data.frame(DSM_HARV_pts)

library(ggplot2)
library(dplyr)

DSM_HARV_df <- DSM_HARV_df %>%
mutate(fct_elevation = cut(HARV_dsmCrop, 3,
labels = c("Low Elevation","Middle Elevation","High Elevation")
)
)

ggplot() +
geom_raster(data = DSM_HARV_df , aes(x = x, y = y, fill = fct_elevation)) +
ggtitle("Classified Elevation Map - NEON Harvard Forest Field Site") +
coord_equal()

```

Raster data has some important advantages:

* representation of continuous surfaces
* potentially very high levels of detail
* data is 'unweighted' across its extent - the geometry doesn't implicitly highlight
features (wording?? unbiased?)
* cell-by-cell calculations can be very fast and efficient

The downsides of raster data are

* very large file sizes as cell size gets smaller
* currently popular formats don't embed metadata well (more on this later!)
* can be difficult to represent complex information

Satellite imagery is probably the most complex raster representation
you will work with. Satellites like Landsat capture information at
multiple wavelengths, from both human-visible and infrared bands.
Final products are split into specific wavelength ranges, so to make
a colour image of the land surface, one may have to combine red,
green, and blue datasets.

## Extent
The spatial extent is the geographic area that the raster data covers.

<figure>
<a href="../images/dc-spatial-raster/spatial_extent.png">
<img src="../images/dc-spatial-raster/spatial_extent.png">
</a>
<figcaption> Image Source: National Ecological Observatory Network (NEON)
</figcaption>
</figure>

The spatial extent of an R spatial object represents the geographic "edge" or
location that is the furthest north, south, east and west. In other words, `extent`
represents the overall geographic coverage of the spatial object.

## Resolution
A raster has horizontal (x and y) resolution. This resolution represents the
area on the ground that each pixel covers. The units for our data are in meters.
Given our data resolution is 1 x 1, this means that each pixel represents a
1 x 1 meter area on the ground.

<figure>
<a href="../images/dc-spatial-raster/raster_resolution.png">
<img src="../images/dc-spatial-raster/raster_resolution.png">
</a>
<figcaption> Source: National Ecological Observatory Network (NEON)
</figcaption>
</figure>

## What is a GeoTIFF??
Raster data can come in many different formats. In this tutorial, we will use the
geotiff format which has the extension `.tif`. A `.tif` file stores metadata
or attributes about the file as embedded `tif tags`. For instance, your camera
might
store a tag that describes the make and model of the camera or the date the
photo was taken when it saves a `.tif`. A GeoTIFF is a standard `.tif` image
format with additional spatial (georeferencing) information embedded in the file
as tags. These tags can include the following raster metadata:

1. A Coordinate Reference System (`CRS`)
2. Spatial Extent (`extent`)
3. Values that represent missing data (`NoDataValue`)
4. The `resolution` of the data

In this tutorial we will discuss all of these metadata tags.

## More Resources on the  `.tif` format
>
> * <a href="https://en.wikipedia.org/wiki/GeoTIFF" target="_blank"> GeoTIFF on Wikipedia</a>
> * <a href="https://trac.osgeo.org/geotiff/" target="_blank"> OSGEO TIFF documentation</a>
{: .callout}

# Multi-band Raster Data

## The Basics of Imagery - About Spectral Remote Sensing Data

<iframe width="560" height="315" src="https://www.youtube.com/embed/3iaFzafWJQE" frameborder="0" allowfullscreen></iframe>

## About Raster Bands in R
As discussed in the
[Intro to Raster Data episode]({{ base.url }}/R/Introduction-to-Raster-Data-In-R),
a raster can contain 1 or more bands.

<figure>
<a href="{{ site.baseurl }}/images/dc-spatial-raster/single_multi_raster.png">
<img src="{{ site.baseurl }}/images/dc-spatial-raster/single_multi_raster.png">
</a>
<figcaption>A raster can contain one or more bands. We can use the
raster function to import one single band from a single OR multi-band
raster.  Source: National Ecological Observatory Network (NEON).</figcaption>
</figure>

To work with multi-band rasters in R, we need to change how we import and plot
our data in several ways.

* To import multi band raster data we will use the `stack()` function.
* If our multi-band data are imagery that we wish to composite, we can use
`plotRGB()` (instead of `plot()`) to plot a 3 band raster image.

## About Multi-Band Imagery
One type of multi-band raster dataset that is familiar to many of us is a color
image. A basic color image consists of three bands: red, green, and blue. Each
band represents light reflected from the red, green or blue portions of the
electromagnetic spectrum. The pixel brightness for each band, when composited
creates the colors that we see in an image.

<figure>
<a href="{{ site.baseurl }}/images/dc-spatial-raster/RGBSTack_1.jpg">
<img src="{{ site.baseurl }}/images/dc-spatial-raster/RGBSTack_1.jpg"></a>
<figcaption>A color image consists of 3 bands - red, green and blue. When
rendered together in a GIS, or even a tool like Photoshop or any other
image software, they create a color image.
Source: National Ecological Observatory Network (NEON).
</figcaption>
</figure>

We can plot each band of a multi-band image individually.

> ## Data Tip
> In many GIS applications, a single band
> would render as a single image in grayscale. We will therefore use a grayscale
> palette to render individual bands.
{: .callout}

```{r demonstrate-RGB-Image, echo=FALSE}
library(raster)
# Use stack function to read in all bands
RGB_stack_HARV <- stack("data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif")

names(RGB_stack_HARV) <- c("Red Band", "Green Band", "Blue Band")

grayscale_colors <- gray.colors(100,
start = 0.0,
end = 1.0,
gamma = 2.2,
alpha = NULL)

# Create an RGB image from the raster stack
plot(RGB_stack_HARV,
col = grayscale_colors,
axes = FALSE)

```

Or we can composite all three bands together to make a color image.

```{r plot-RGB-now, echo=FALSE, message=FALSE }
# Create an RGB image from the raster stack

original_par <- par() # create original par for easy reversal at end
par(col.axis = "white", col.lab = "white", tck = 0)
plotRGB(RGB_stack_HARV, r = 1, g = 2, b = 3,
axes = TRUE,
main = "3 Band Color Composite Image\n NEON Harvard Forest Field Site")
box(col = "white")

```

In a multi-band dataset, the rasters will always have the same *extent*,
*CRS* and *resolution*.

```{r reset-par, echo=FALSE, results="hide", warning=FALSE}
par(original_par) # go back to original par

```

## Other Types of Multi-band Raster Data

Multi-band raster data might also contain:

1. **Time series:** the same variable, over the same area, over time. Check out
[Raster Time Series Data in R ]({{site.baseurl}}/R/Raster-Times-Series-Data-In-R/)
to learn more about time series stacks.
2. **Multi or hyperspectral imagery:** image rasters that have 4 or more
(multi-spectral) or more than 10-15 (hyperspectral) bands. Check out the NEON
Data Skills
[Imaging Spectroscopy HDF5 in R ]({{site.baseurl}}/HDF5/Imaging-Spectroscopy-HDF5-In-R/)
episode for more about working with hyperspectral data cubes.

## Common storage formats  

Many geospatial raster formats are just existing image formats with an extended definition that allows CRS information to be embedded in the file. GeoTIFF is one of the most common of these, along with MrSID, JPEG2000 and IMG. Other formats are ASCII-based (GRD, XYZ, ASC), with a few rows of plain-text header information followed by cell values arranged in rows and columns. These are often less useful due to their inefficient storage. More robust, but more complicated formats like NetCDF are available, but not commonly used outside of research. Other formats are industry-specific, like GRIB for meteorology. 